// Prisma schema for Strakly - PUBLIC SCHEMA ONLY
// Tenant-specific tables (clients, memberships, etc.) are created dynamically via TenantService
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// SYSTEM USERS (Superadmins - platform level)
// ============================================

model SystemUser {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  role          String    @default("superadmin")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  notifications SystemNotification[]

  @@map("system_users")
}

// ============================================
// SYSTEM NOTIFICATIONS (Superadmin notifications)
// ============================================

model SystemNotification {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  type        String    // new_gym, subscription_expiry, support_ticket, system_alert, etc.
  title       String
  message     String
  data        Json?     // Additional data like gymId, ticketId, etc.
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  actionUrl   String?   @map("action_url")
  priority    String    @default("normal") // low, normal, high, urgent
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user        SystemUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("system_notifications")
}

// ============================================
// USERS (Staff: Admin, Manager, Trainer)
// ============================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  phone         String?
  avatar        String?
  bio           String?
  dateOfBirth   DateTime? @map("date_of_birth")
  gender        String?
  address       String?
  city          String?
  state         String?
  zipCode       String?   @map("zip_code")
  status        String    @default("active") // onboarding, confirm, active, expired, inactive, rejected, archive
  statusId      Int?      @map("status_id") // Reference to lookups.id for status
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  isDeleted     Boolean   @default(false) @map("is_deleted") // Soft delete
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  gymAssignments  UserGymXref[]

  @@index([email])
  @@index([status])
  @@index([isDeleted])
  @@map("users")
}

// ============================================
// USER-GYM CROSS REFERENCE (Many-to-Many)
// ============================================

model UserGymXref {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  gymId       Int       @map("gym_id")
  branchId    Int?      @map("branch_id") // null = all branches access
  role        String    // admin, manager, trainer
  isPrimary   Boolean   @default(false) @map("is_primary") // Primary gym for this user
  isActive    Boolean   @default(true) @map("is_active")
  joinedAt    DateTime  @default(now()) @map("joined_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym         Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  branch      Branch?   @relation(fields: [branchId], references: [id])

  @@unique([userId, gymId])
  @@index([userId])
  @@index([gymId])
  @@index([branchId])
  @@index([role])
  @@map("user_gym_xref")
}

// ============================================
// GYM MODEL (Tenant Registry)
// ============================================

model Gym {
  id                Int       @id @default(autoincrement())

  // Tenant identification
  tenantSchemaName  String?   @unique @map("tenant_schema_name") // e.g., "tenant_1", null if not created yet

  // Basic info
  name              String
  description       String?
  logo              String?

  // Contact
  phone             String?
  email             String?
  website           String?

  // Address
  address           String?
  city              String?
  state             String?
  zipCode           String?   @map("zip_code")
  country           String?   @default("India")

  // Operating hours (stored as HH:MM format)
  openingTime       String?   @map("opening_time")
  closingTime       String?   @map("closing_time")

  // Capacity and facilities
  capacity          Int?
  amenities         Json?     // Array of amenities like ["Parking", "AC", "Locker", "Shower"]

  // Status
  isActive          Boolean   @default(true) @map("is_active")

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  userAssignments   UserGymXref[]
  subscription      SaasGymSubscription?
  supportTickets    SupportTicket[]
  branches          Branch[]

  @@map("gyms")
}

// ============================================
// BRANCH MODEL (Multi-location support)
// ============================================

model Branch {
  id              Int       @id @default(autoincrement())
  gymId           Int       @map("gym_id")

  // Basic info
  name            String
  code            String    // e.g., "KP", "HNJ", "MAIN"

  // Contact
  phone           String?
  email           String?

  // Address
  address         String?
  city            String?
  state           String?
  zipCode         String?   @map("zip_code")

  // Status
  isActive        Boolean   @default(true) @map("is_active")
  isDefault       Boolean   @default(false) @map("is_default")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  gym             Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  userAssignments UserGymXref[]

  @@unique([gymId, code])
  @@index([gymId])
  @@index([isActive])
  @@map("branches")
}

// ============================================
// LOOKUP TABLES (Shared across all tenants)
// ============================================

model LookupType {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  lookups     Lookup[]

  @@map("lookup_types")
}

model Lookup {
  id            Int        @id @default(autoincrement())
  lookupTypeId  Int        @map("lookup_type_id")
  code          String
  name          String
  value         String?
  displayOrder  Int        @default(0) @map("display_order")
  isActive      Boolean    @default(true) @map("is_active")
  metadata      Json?

  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  lookupType    LookupType @relation(fields: [lookupTypeId], references: [id], onDelete: Cascade)

  @@unique([lookupTypeId, code])
  @@map("lookups")
}

// ============================================
// PERMISSION TABLES (Shared across all tenants)
// ============================================

model Permission {
  id          Int              @id @default(autoincrement())
  code        String           @unique
  name        String
  module      String
  description String?
  isActive    Boolean          @default(true) @map("is_active")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermissionXref[]

  @@index([module])
  @@map("permissions")
}

model RolePermissionXref {
  id           Int        @id @default(autoincrement())
  role         String
  permissionId Int        @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@map("role_permission_xref")
}

// ============================================
// SAAS SUBSCRIPTION MODELS
// ============================================

model SaasPlan {
  id              Int       @id @default(autoincrement())
  code            String    @unique
  name            String
  description     String?

  // Pricing
  price           Decimal   @db.Decimal(10, 2)
  currency        String    @default("INR")
  billingPeriod   String    @default("monthly") @map("billing_period")

  // Limits
  maxMembers      Int       @default(-1) @map("max_members")
  maxStaff        Int       @default(-1) @map("max_staff")
  maxBranches     Int       @default(1) @map("max_branches")

  // Features
  features        Json?

  // Display
  displayOrder    Int       @default(0) @map("display_order")
  isFeatured      Boolean   @default(false) @map("is_featured")
  badge           String?
  isActive        Boolean   @default(true) @map("is_active")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  gymSubscriptions SaasGymSubscription[]

  @@index([isActive, displayOrder])
  @@map("saas_plans")
}

model SaasGymSubscription {
  id              Int       @id @default(autoincrement())
  gymId           Int       @unique @map("gym_id")
  planId          Int       @map("plan_id")

  // Subscription period
  startDate       DateTime  @map("start_date")
  endDate         DateTime  @map("end_date")
  status          String    @default("trial") // active, expired, cancelled, trial, suspended

  // Trial info
  trialEndsAt     DateTime? @map("trial_ends_at")

  // Payment details
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("INR")
  paymentStatus   String    @default("pending") @map("payment_status")
  paymentMethod   String?   @map("payment_method")
  paymentRef      String?   @map("payment_ref")
  lastPaymentAt   DateTime? @map("last_payment_at")
  nextPaymentAt   DateTime? @map("next_payment_at")

  // Cancellation
  cancelledAt     DateTime? @map("cancelled_at")
  cancelReason    String?   @map("cancel_reason")

  // Auto-renewal
  autoRenew       Boolean   @default(true) @map("auto_renew")
  notes           String?
  isActive        Boolean   @default(true) @map("is_active")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  gym             Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  plan            SaasPlan  @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([planId])
  @@index([paymentStatus])
  @@index([endDate, status])
  @@map("saas_gym_subscriptions")
}

// ============================================
// SUPPORT TICKET MODEL
// ============================================

model SupportTicket {
  id              Int       @id @default(autoincrement())
  ticketNumber    String    @unique @map("ticket_number")
  subject         String
  description     String
  category        String    @default("general")
  priority        String    @default("medium")
  status          String    @default("open")

  // User info (can be staff from public.users or client from tenant)
  userType        String    @map("user_type") // staff, client
  userId          Int       @map("user_id") // public.users.id for staff, tenant.users.id for client
  userEmail       String    @map("user_email")
  userName        String    @map("user_name")

  // Gym reference
  gymId           Int       @map("gym_id")

  // Admin assigned
  assignedToId    Int?      @map("assigned_to_id")

  // Resolution
  resolution      String?
  resolvedAt      DateTime? @map("resolved_at")
  closedAt        DateTime? @map("closed_at")

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  messages        SupportTicketMessage[]
  gym             Gym       @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gymId])
  @@index([status])
  @@index([assignedToId])
  @@index([priority, status])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id              Int       @id @default(autoincrement())
  ticketId        Int       @map("ticket_id")
  message         String

  // Sender info
  senderId        Int       @map("sender_id")
  senderName      String    @map("sender_name")
  senderType      String    @map("sender_type") // staff, client, admin, system

  attachment      String?
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  ticket          SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
  @@map("support_ticket_messages")
}

// ============================================
// EMAIL VERIFICATION MODEL (also used for password reset)
// ============================================

model EmailVerification {
  id          Int       @id @default(autoincrement())
  email       String
  otp         String
  expiresAt   DateTime  @map("expires_at")
  isUsed      Boolean   @default(false) @map("is_used")
  attempts    Int       @default(0)
  userType    String    @map("user_type") // signup, password_reset, admin, staff, client
  userId      Int       @map("user_id") // 0 for signup/password_reset before user exists
  gymId       Int?      @map("gym_id") // null for admin users in public schema
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([email, otp])
  @@index([expiresAt])
  @@index([userId])
  @@index([userType])
  @@map("email_verifications")
}

// ============================================
// CONTACT REQUEST MODEL
// ============================================

model ContactRequest {
  id              Int       @id @default(autoincrement())
  requestNumber   String    @unique @map("request_number")

  // Contact info
  name            String
  email           String
  phone           String?

  // Request details
  subject         String?
  message         String
  status          String    @default("new") // new, read, replied, closed

  // Admin notes
  adminNotes      String?   @map("admin_notes")
  repliedAt       DateTime? @map("replied_at")
  repliedBy       Int?      @map("replied_by")

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@map("contact_requests")
}
