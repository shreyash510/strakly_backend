// Prisma schema for Strakly
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model
model User {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique
  passwordHash String      @map("password_hash")

  // Optional profile fields
  phone        String?
  avatar       String?
  bio          String?
  dateOfBirth  String?     @map("date_of_birth")
  address      String?
  city         String?
  state        String?
  zipCode      String?     @map("zip_code")

  // Lookup references (storing lookup code for flexibility)
  role           String      @default("user")
  status         String      @default("active")
  gender         String?
  attendanceCode String?     @unique @map("attendance_code")

  // Tracking
  joinDate     String?     @map("join_date")
  lastLoginAt  String?     @map("last_login_at")

  // Timestamps
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map("users")
}

// LookupType model - Categories for lookup values
model LookupType {
  id          String    @id @default(uuid())
  code        String    @unique
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  lookups     Lookup[]

  @@map("lookup_types")
}

// Lookup model - Actual lookup values
model Lookup {
  id            String     @id @default(uuid())
  lookupTypeId  String     @map("lookup_type_id")
  code          String
  name          String
  value         String?
  displayOrder  Int        @default(0) @map("display_order")
  isActive      Boolean    @default(true) @map("is_active")
  metadata      Json?      // For any additional data

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  lookupType    LookupType @relation(fields: [lookupTypeId], references: [id], onDelete: Cascade)

  @@unique([lookupTypeId, code])
  @@map("lookups")
}

// Permission model - Defines all available permissions
model Permission {
  id          String           @id @default(uuid())
  code        String           @unique  // e.g., "users.create", "users.read", "attendance.mark"
  name        String                    // e.g., "Create Users", "Read Users"
  module      String                    // e.g., "users", "attendance", "lookups"
  description String?
  isActive    Boolean          @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([module])
  @@map("permissions")
}

// RolePermission model - Links roles to permissions
model RolePermission {
  id           String     @id @default(uuid())
  role         String     // Role code from lookup (e.g., "admin", "manager")
  permissionId String     @map("permission_id")

  // Timestamps
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@map("role_permissions")
}

// Attendance model - Active check-in sessions
model Attendance {
  id              String    @id @default(uuid())
  odooEmployeeId  String?   @map("odoo_employee_id")
  odooUserId      String?   @map("odoo_user_id")
  userId          String    @map("user_id")
  userName        String    @map("user_name")
  userEmail       String    @map("user_email")
  attendanceCode  String    @map("attendance_code")
  checkInTime     DateTime  @map("check_in_time")
  checkOutTime    DateTime? @map("check_out_time")
  date            String    // YYYY-MM-DD format
  markedBy        String    @map("marked_by")
  markedByName    String    @map("marked_by_name")
  status          String    @default("present") // present, checked_out

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([userId, date])
  @@index([date, status])
  @@index([attendanceCode])
  @@map("attendance")
}

// AttendanceHistory model - Completed attendance records
model AttendanceHistory {
  id                String    @id @default(uuid())
  odooEmployeeId    String?   @map("odoo_employee_id")
  odooUserId        String?   @map("odoo_user_id")
  userId            String    @map("user_id")
  userName          String    @map("user_name")
  userEmail         String    @map("user_email")
  attendanceCode    String    @map("attendance_code")
  checkInTime       DateTime  @map("check_in_time")
  checkOutTime      DateTime  @map("check_out_time")
  date              String    // YYYY-MM-DD format
  duration          Int?      // Duration in minutes
  markedBy          String    @map("marked_by")
  markedByName      String    @map("marked_by_name")
  checkedOutBy      String?   @map("checked_out_by")
  checkedOutByName  String?   @map("checked_out_by_name")
  status            String    @default("checked_out")

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([userId, date])
  @@index([date])
  @@index([userId, checkInTime])
  @@index([attendanceCode, date])
  @@map("attendance_history")
}
