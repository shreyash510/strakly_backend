// Prisma schema for Strakly
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model
model User {
  id           Int         @id @default(autoincrement())
  name         String
  email        String      @unique
  passwordHash String      @map("password_hash")

  // Optional profile fields
  phone        String?
  avatar       String?
  bio          String?
  dateOfBirth  String?     @map("date_of_birth")
  address      String?
  city         String?
  state        String?
  zipCode      String?     @map("zip_code")

  // Lookup references
  roleId         Int         @map("role_id")
  status         String      @default("active")
  gender         String?
  attendanceCode String?     @unique @map("attendance_code")

  // Role relation
  role           Lookup      @relation(fields: [roleId], references: [id])

  // Tracking
  joinDate     String?     @map("join_date")
  lastLoginAt  String?     @map("last_login_at")

  // Timestamps
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  memberships        Membership[]
  bodyMetrics        BodyMetrics?
  bodyMetricsHistory BodyMetricsHistory[]
  attendances        Attendance[]
  attendanceHistory  AttendanceHistory[]

  @@map("users")
}

// LookupType model - Categories for lookup values
model LookupType {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  lookups     Lookup[]

  @@map("lookup_types")
}

// Lookup model - Actual lookup values
model Lookup {
  id            Int        @id @default(autoincrement())
  lookupTypeId  Int        @map("lookup_type_id")
  code          String
  name          String
  value         String?
  displayOrder  Int        @default(0) @map("display_order")
  isActive      Boolean    @default(true) @map("is_active")
  metadata      Json?      // For any additional data

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  lookupType    LookupType @relation(fields: [lookupTypeId], references: [id], onDelete: Cascade)
  users         User[]     // Users with this lookup as their role

  @@unique([lookupTypeId, code])
  @@map("lookups")
}

// Permission model - Defines all available permissions
model Permission {
  id          Int              @id @default(autoincrement())
  code        String           @unique  // e.g., "users.create", "users.read", "attendance.mark"
  name        String                    // e.g., "Create Users", "Read Users"
  module      String                    // e.g., "users", "attendance", "lookups"
  description String?
  isActive    Boolean          @default(true) @map("is_active")

  // Timestamps
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([module])
  @@map("permissions")
}

// RolePermission model - Links roles to permissions
model RolePermission {
  id           Int        @id @default(autoincrement())
  role         String     // Role code from lookup (e.g., "admin", "manager")
  permissionId Int        @map("permission_id")

  // Timestamps
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@map("role_permissions")
}

// Attendance model - Active check-in sessions
model Attendance {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  checkInTime     DateTime  @map("check_in_time")
  checkOutTime    DateTime? @map("check_out_time")
  date            String    // YYYY-MM-DD format
  markedById      Int       @map("marked_by_id")
  status          String    @default("present") // present, checked_out

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([date, status])
  @@map("attendance")
}

// AttendanceHistory model - Completed attendance records
model AttendanceHistory {
  id                Int       @id @default(autoincrement())
  userId            Int       @map("user_id")
  checkInTime       DateTime  @map("check_in_time")
  checkOutTime      DateTime  @map("check_out_time")
  date              String    // YYYY-MM-DD format
  duration          Int?      // Duration in minutes
  markedById        Int       @map("marked_by_id")
  checkedOutById    Int?      @map("checked_out_by_id")
  status            String    @default("checked_out")

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([date])
  @@index([userId, checkInTime])
  @@map("attendance_history")
}

// ============================================
// MEMBERSHIP & SUBSCRIPTION MODELS
// ============================================

// Plan model - Membership plans available
model Plan {
  id              Int          @id @default(autoincrement())
  code            String       @unique                    // e.g., "basic", "premium", "vip"
  name            String                                  // e.g., "Basic Plan", "Premium Plan"
  description     String?

  // Duration
  durationValue   Int          @map("duration_value")     // e.g., 1, 3, 6, 12
  durationType    String       @map("duration_type")      // day, month, year

  // Pricing
  price           Decimal      @db.Decimal(10, 2)         // Base price
  currency        String       @default("INR")

  // Features (JSON array of feature strings or objects)
  features        Json?                                   // e.g., ["Gym Access", "Personal Trainer", "Diet Plan"]

  // Display
  displayOrder    Int          @default(0) @map("display_order")
  isFeatured      Boolean      @default(false) @map("is_featured")  // Highlighted plan
  isActive        Boolean      @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  planOffers      PlanOffer[]
  memberships     Membership[]

  @@index([isActive, displayOrder])
  @@map("plans")
}

// Offer model - Discounts and promotions
model Offer {
  id                Int          @id @default(autoincrement())
  code              String       @unique                  // e.g., "SUMMER20", "NEWYEAR50"
  name              String                                // e.g., "Summer Sale", "New Year Offer"
  description       String?

  // Discount
  discountType      String       @map("discount_type")    // percentage, fixed
  discountValue     Decimal      @map("discount_value") @db.Decimal(10, 2)  // 20 for 20% or 500 for â‚¹500

  // Validity
  validFrom         DateTime     @map("valid_from")
  validTo           DateTime     @map("valid_to")

  // Usage limits
  maxUsageCount     Int?         @map("max_usage_count")  // null = unlimited
  usedCount         Int          @default(0) @map("used_count")
  maxUsagePerUser   Int?         @map("max_usage_per_user")  // null = unlimited per user

  // Conditions
  minPurchaseAmount Decimal?     @map("min_purchase_amount") @db.Decimal(10, 2)
  applicableToAll   Boolean      @default(true) @map("applicable_to_all")  // If false, check PlanOffer

  // Status
  isActive          Boolean      @default(true) @map("is_active")

  // Timestamps
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations
  planOffers        PlanOffer[]
  memberships       Membership[]

  @@index([isActive, validFrom, validTo])
  @@index([code])
  @@map("offers")
}

// PlanOffer model - Many-to-many: which offers apply to which plans
model PlanOffer {
  id        Int      @id @default(autoincrement())
  planId    Int      @map("plan_id")
  offerId   Int      @map("offer_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  offer     Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@unique([planId, offerId])
  @@map("plan_offers")
}

// Membership model - User's subscription/membership record
model Membership {
  id              Int       @id @default(autoincrement())

  // User reference
  userId          Int       @map("user_id")

  // Plan reference
  planId          Int       @map("plan_id")

  // Offer reference (optional - if discount was applied)
  offerId         Int?      @map("offer_id")

  // Membership period
  startDate       DateTime  @map("start_date")
  endDate         DateTime  @map("end_date")

  // Status: active, expired, cancelled, paused, pending
  status          String    @default("pending")

  // Payment details
  originalAmount  Decimal   @map("original_amount") @db.Decimal(10, 2)
  discountAmount  Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  finalAmount     Decimal   @map("final_amount") @db.Decimal(10, 2)
  currency        String    @default("INR")

  // Payment status: paid, pending, failed, refunded
  paymentStatus   String    @default("pending") @map("payment_status")
  paymentMethod   String?   @map("payment_method")  // cash, card, upi, online
  paymentRef      String?   @map("payment_ref")     // Transaction reference
  paidAt          DateTime? @map("paid_at")

  // Cancellation
  cancelledAt     DateTime? @map("cancelled_at")
  cancelReason    String?   @map("cancel_reason")

  // Additional info
  notes           String?

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan      @relation(fields: [planId], references: [id])
  offer           Offer?    @relation(fields: [offerId], references: [id])

  @@index([userId, status])
  @@index([status, endDate])
  @@index([planId])
  @@map("memberships")
}

// ============================================
// BODY METRICS MODELS
// ============================================

// BodyMetrics model - Current/latest body metrics for a user
model BodyMetrics {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")

  // Basic measurements
  height          Decimal?  @db.Decimal(5, 2)   // in cm
  weight          Decimal?  @db.Decimal(5, 2)   // in kg
  bmi             Decimal?  @db.Decimal(4, 2)   // Body Mass Index

  // Body composition
  bodyFat         Decimal?  @map("body_fat") @db.Decimal(4, 2)      // percentage
  muscleMass      Decimal?  @map("muscle_mass") @db.Decimal(5, 2)   // in kg
  boneMass        Decimal?  @map("bone_mass") @db.Decimal(4, 2)     // in kg
  waterPercentage Decimal?  @map("water_percentage") @db.Decimal(4, 2)  // percentage

  // Measurements (in cm)
  chest           Decimal?  @db.Decimal(5, 2)
  waist           Decimal?  @db.Decimal(5, 2)
  hips            Decimal?  @db.Decimal(5, 2)
  biceps          Decimal?  @db.Decimal(5, 2)
  thighs          Decimal?  @db.Decimal(5, 2)
  calves          Decimal?  @db.Decimal(5, 2)
  shoulders       Decimal?  @db.Decimal(5, 2)
  neck            Decimal?  @db.Decimal(5, 2)

  // Health indicators
  restingHeartRate  Int?    @map("resting_heart_rate")  // bpm
  bloodPressureSys  Int?    @map("blood_pressure_sys")  // systolic
  bloodPressureDia  Int?    @map("blood_pressure_dia")  // diastolic

  // Goals
  targetWeight    Decimal?  @map("target_weight") @db.Decimal(5, 2)
  targetBodyFat   Decimal?  @map("target_body_fat") @db.Decimal(4, 2)

  // Last measured
  lastMeasuredAt  DateTime? @map("last_measured_at")
  measuredBy      String?   @map("measured_by")  // trainer/self

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("body_metrics")
}

// BodyMetricsHistory model - Historical body metrics records
model BodyMetricsHistory {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")

  // Measurement date
  measuredAt      DateTime  @map("measured_at")

  // Basic measurements
  height          Decimal?  @db.Decimal(5, 2)   // in cm
  weight          Decimal?  @db.Decimal(5, 2)   // in kg
  bmi             Decimal?  @db.Decimal(4, 2)   // Body Mass Index

  // Body composition
  bodyFat         Decimal?  @map("body_fat") @db.Decimal(4, 2)
  muscleMass      Decimal?  @map("muscle_mass") @db.Decimal(5, 2)
  boneMass        Decimal?  @map("bone_mass") @db.Decimal(4, 2)
  waterPercentage Decimal?  @map("water_percentage") @db.Decimal(4, 2)

  // Measurements (in cm)
  chest           Decimal?  @db.Decimal(5, 2)
  waist           Decimal?  @db.Decimal(5, 2)
  hips            Decimal?  @db.Decimal(5, 2)
  biceps          Decimal?  @db.Decimal(5, 2)
  thighs          Decimal?  @db.Decimal(5, 2)
  calves          Decimal?  @db.Decimal(5, 2)
  shoulders       Decimal?  @db.Decimal(5, 2)
  neck            Decimal?  @db.Decimal(5, 2)

  // Health indicators
  restingHeartRate  Int?    @map("resting_heart_rate")
  bloodPressureSys  Int?    @map("blood_pressure_sys")
  bloodPressureDia  Int?    @map("blood_pressure_dia")

  // Metadata
  measuredBy      String?   @map("measured_by")
  notes           String?

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, measuredAt])
  @@index([userId, createdAt])
  @@map("body_metrics_history")
}

// ============================================
// GYM MANAGEMENT MODEL
// ============================================

// Gym model - Gym/Branch details
model Gym {
  id              Int       @id @default(autoincrement())

  // Basic info
  name            String
  description     String?
  logo            String?

  // Contact
  phone           String?
  email           String?
  website         String?

  // Address
  address         String?
  city            String?
  state           String?
  zipCode         String?   @map("zip_code")
  country         String?   @default("India")

  // Operating hours (stored as HH:MM format)
  openingTime     String?   @map("opening_time")
  closingTime     String?   @map("closing_time")

  // Capacity and facilities
  capacity        Int?
  amenities       Json?     // Array of amenities like ["Parking", "AC", "Locker", "Shower"]

  // Status
  isActive        Boolean   @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("gyms")
}
